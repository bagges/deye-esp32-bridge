esphome:
  name: deye-esp32
  platform: ESP32
  board: nodemcu-32s

logger:
  level: INFO

substitutions:
  bms_name: pace-bms
  modbus_update_interval: "8s"
  settings_skipped_updates: "10"
  query_throttle: "50ms"
  device_name: deye
  device_type: sun10k
  device_description: "Esphome component for Deye sun-10k-sg04lp3"
  modbus_controller_id: sg04lp3
  
api:

captive_portal:

uart:
  - id: uartdeye
    tx_pin: 27
    rx_pin: 26
    baud_rate: 9600
  - id: uartpace
    tx_pin: 17
    rx_pin: 16
    baud_rate: 9600
    debug:
      direction: BOTH
      dummy_receiver: false

modbus_controller:
  - id: ${modbus_controller_id}
    address: 0x01
    modbus_id: modbus1
    setup_priority: -10
    update_interval: ${modbus_update_interval}
    command_throttle: ${query_throttle}
  - id: bms0
    # Slave address 0x01
    address: 0x01
    modbus_id: modbus0
    command_throttle: 200ms
    update_interval: 10s
    
modbus:
  - id: modbus1
    uart_id: uartdeye
  - id: modbus0
    uart_id: uartpace
    send_wait_time: 200ms

ota:
  password: ""

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

web_server:
  port: 80

time:
  - platform: sntp
    id: sntp_time
    timezone: Europe/Berlin
    servers:
    - pool.ntp.org
    
switch:
  - platform: restart
    name: "Restart ESP32-Deye Bridge"
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: ${device_type}_Solar_sell
    register_type: holding
    address: 145
    bitmask: 1
    entity_category: config
    icon: "mdi:toggle-switch"
 
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: ${device_type}-Grid_Charge
    register_type: holding
    address: 130
    bitmask: 1
    entity_category: config
    icon: "mdi:toggle-switch"
 
  - platform: modbus_controller  # Advanced peak shaving and valley filling function enabled
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: ${device_type}-Time of Use 
    id: ${device_type}_Time_of_Use
    register_type: holding
    address: 146
    bitmask: 1
    entity_category: config
    icon: "mdi:toggle-switch"
 
  - platform: modbus_controller  # Time point 1 charge enable - grid charging enable
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: ${device_type}-Time point 1 charge enable
    register_type: holding
    address: 172
    bitmask: 1   # 2 hvis man ønsker Gen charging enabel i sted for.
    entity_category: config
    icon: "mdi:toggle-switch"
 
  - platform: modbus_controller  # Time point 2 charge enable - grid charging enable
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: ${device_type}-Time point 2 charge enable
    register_type: holding
    address: 173
    bitmask: 1    # 2 hvis man ønsker Gen charging enabel i sted for.
    entity_category: config
    icon: "mdi:toggle-switch"
 
  - platform: modbus_controller  # Time point 3 charge enable - grid charging enable
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: ${device_type}-Time point 3 charge enable
    register_type: holding
    address: 174
    bitmask: 1    # 2 hvis man ønsker Gen charging enabel i sted for.
    entity_category: config
    icon: "mdi:toggle-switch"
 
  - platform: modbus_controller  # Time point 4 charge enable - grid charging enable
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: ${device_type}-Time point 4 charge enable
    register_type: holding
    address: 175
    bitmask: 1    # 2 hvis man ønsker Gen charging enabel i sted for.
    entity_category: config
    icon: "mdi:toggle-switch"
 
  - platform: modbus_controller  # Time point 5 charge enable - grid charging enable
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: ${device_type}-Time point 5 charge enable
    register_type: holding
    address: 176
    bitmask: 1    # 2 hvis man ønsker Gen charging enabel i sted for.
    entity_category: config
    icon: "mdi:toggle-switch"
 
  - platform: modbus_controller  # Time point 6 charge enable - grid charging enable
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    name: ${device_type}-Time point 6 charge enable
    register_type: holding
    address: 177
    bitmask: 1    # 2 hvis man ønsker Gen charging enabel i sted for.
    entity_category: config
    icon: "mdi:toggle-switch"

binary_sensor:
### PACE

  #  11  Status/Fault flag                     2 byte   R  uint16  Hex See ^3
  #      Bit 8: Status: Charging enabled/disabled
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} charging"
    address: 11
    register_type: holding
    bitmask: 0x0080

  #      Bit 9: Status: Discharging enabled/disabled
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} discharging"
    address: 11
    register_type: holding
    bitmask: 0x0100


### DEYE
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: ${device_type}-AC INV relay # bit 0
    id: ${device_type}_AC_INV_relay
    register_type: holding
    address: 552
    bitmask: 0x1
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: ${device_type}-AC Load relay Reserved # bit 1
    id: ${device_type}_AC_Load_relay_Reserved
    register_type: holding
    address: 552
    bitmask: 0x2
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: ${device_type}-AC grid relay # bit 2
    id: ${device_type}_AC_grid_relay
    register_type: holding
    address: 552
    bitmask: 0x4
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: ${device_type}-AC Generator relay # bit 3
    id: ${device_type}_AC_Generator_relay
    register_type: holding
    address: 552
    bitmask: 0x8
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: ${device_type}-Turn off/on status   #The lower 4 bits represent the switch signal
    id: ${device_type}_Turn_off_on_status
    register_type: holding
    address: 551
    bitmask: 0x1
 
text_sensor:
### PACE
  #   9  Warning flag                          2 byte   R  uint16  Hex See ^1
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} warnings"
    address: 9
    register_type: holding
    register_count: 1
    response_size: 2
    raw_encode: HEXBYTES
    lambda: |-
      static const uint8_t WARNINGS_SIZE = 16;
      static const char *const WARNINGS[WARNINGS_SIZE] = {
          "Cell overvoltage",              // 0000 0000 0000 0001 (1)
          "Cell undervoltage",             // 0000 0000 0000 0010 (2)
          "Pack overvoltage",              // 0000 0000 0000 0100 (3)
          "Pack undervoltage",             // 0000 0000 0000 1000 (4)
          "Charging overcurrent",          // 0000 0000 0001 0000 (5)
          "Discharging overcurrent",       // 0000 0000 0010 0000 (6)
          "Reserve (Bit 7)",               // 0000 0000 0100 0000 (7)
          "Reserve (Bit 8)",               // 0000 0000 1000 0000 (8)
          "Charging overtemperature",      // 0000 0001 0000 0000 (9)
          "Discharging overtemperature",   // 0000 0010 0000 0000 (10)
          "Charging undertemperature",     // 0000 0100 0000 0000 (11)
          "Discharging undertemperature",  // 0000 1000 0000 0000 (12)
          "Environment overtemperature",   // 0001 0000 0000 0000 (13)
          "Environment undertemperature",  // 0010 0000 0000 0000 (14)
          "MOSFET overtemperature",        // 0100 0000 0000 0000 (15)
          "Low state of charge",           // 1000 0000 0000 0000 (16)
      };
      std::string values = "";

      uint16_t mask = modbus_controller::word_from_hex_str(x, 0);
      if (mask) {
        for (int i = 0; i < WARNINGS_SIZE; i++) {
          if (mask & (1 << i)) {
            values.append(WARNINGS[i]);
            values.append(";");
          }
        }
        if (!values.empty()) {
          values.pop_back();
        }
      }
      return values;

  #  10  Protection flag                       2 byte   R  uint16  Hex See ^2
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} protections"
    address: 10
    register_type: holding
    register_count: 1
    response_size: 2
    raw_encode: HEXBYTES
    lambda: |-
      static const uint8_t PROTECTIONS_SIZE = 16;
      static const char *const PROTECTIONS[PROTECTIONS_SIZE] = {
          "Cell overvoltage",              // 0000 0000 0000 0001 (1)
          "Cell undervoltage",             // 0000 0000 0000 0010 (2)
          "Pack overvoltage",              // 0000 0000 0000 0100 (3)
          "Pack undervoltage",             // 0000 0000 0000 1000 (4)
          "Charging overcurrent",          // 0000 0000 0001 0000 (5)
          "Discharging overcurrent",       // 0000 0000 0010 0000 (6)
          "Short circuit",                 // 0000 0000 0100 0000 (7)
          "Charging overvoltage",          // 0000 0000 1000 0000 (8)
          "Charging overtemperature",      // 0000 0001 0000 0000 (9)
          "Discharging overtemperature",   // 0000 0010 0000 0000 (10)
          "Charging undertemperature",     // 0000 0100 0000 0000 (11)
          "Discharging undertemperature",  // 0000 1000 0000 0000 (12)
          "MOSFET overtemperature",        // 0001 0000 0000 0000 (13)
          "Environment overtemperature",   // 0010 0000 0000 0000 (14)
          "Environment undertemperature",  // 0100 0000 0000 0000 (15)
          "Reserve (Bit 16)",              // 1000 0000 0000 0000 (16)
      };
      std::string values = "";

      uint16_t mask = modbus_controller::word_from_hex_str(x, 0);
      if (mask) {
        for (int i = 0; i < PROTECTIONS_SIZE; i++) {
          if (mask & (1 << i)) {
            values.append(PROTECTIONS[i]);
            values.append(";");
          }
        }
        if (!values.empty()) {
          values.pop_back();
        }
      }
      return values;

  #  11  Status/Fault flag                     2 byte   R  uint16  Hex See ^3
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} errors"
    address: 11
    register_type: holding
    register_count: 1
    response_size: 2
    raw_encode: HEXBYTES
    lambda: |-
      static const uint8_t FAULTS_SIZE = 8;
      static const char *const FAULTS[FAULTS_SIZE] = {
          "Charging MOSFET fault",                   // 0000 0000 0000 0001 (1)
          "Discharging MOSFET fault",                // 0000 0000 0000 0010 (2)
          "Temperature sensor",                      // 0000 0000 0000 0100 (3)
          "Reserve (Bit 4)",                         // 0000 0000 0000 1000 (4)
          "Battery cell fault",                      // 0000 0000 0001 0000 (5)
          "Front end sampling communication fault",  // 0000 0000 0010 0000 (6)
          "Reserve (Bit 7)",                         // 0000 0000 0100 0000 (7)
          "Reserve (Bit 8)",                         // 0000 0000 1000 0000 (8)
      };
      std::string values = "";

      uint16_t mask = modbus_controller::word_from_hex_str(x, 0);
      if (mask) {
        for (int i = 0; i < FAULTS_SIZE; i++) {
          if (mask & (1 << i)) {
            values.append(FAULTS[i]);
            values.append(";");
          }
        }
        if (!values.empty()) {
          values.pop_back();
        }
      }
      return values;

  # 150  Version information                  20 byte   R  uint16  ASCII
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} version information"
    skip_updates: 60
    address: 150
    register_type: holding
    register_count: 10
    response_size: 20

  # 160  Model SN                             20 byte  RW  uint16  ASCII BMS Manufacturer
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} bms serial number"
    skip_updates: 60
    address: 160
    register_type: holding
    register_count: 10
    response_size: 20

  # 170  PACK SN                              20 byte  RW  uint16  ASCII PACK Manufacturer
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} battery pack serial number"
    skip_updates: 60
    address: 170
    register_type: holding
    register_count: 10
    response_size: 20


### DEYE
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    id: ${device_type}_Running_Status
    bitmask: 0
    register_type: holding
    address: 500
    raw_encode: HEXBYTES
    name: ${device_type}-Running Status
    lambda: |-
      uint16_t value = modbus_controller::word_from_hex_str(x, 0);
      switch (value) {
        case 0: return std::string("standby");
        case 1: return std::string("selfcheck");
        case 2: return std::string("normal");
        case 3: return std::string("alarm");
        case 4: return std::string("fault");
        default: return std::string("----");
      }
      return x;

number:
## PACE
  #  60  Pack OV alarm                         2 byte  RW  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} pack overvoltage alarm"
    use_write_multiple: true
    address: 60
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "mV"

  #  61  Pack OV protection                    2 byte  RW  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} pack overvoltage protection"
    use_write_multiple: true
    address: 61
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "mV"

  #  62  Pack OV release protection            2 byte  RW  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} pack overvoltage protection release"
    use_write_multiple: true
    address: 62
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "mV"

  #  63  Pack OV protection delay time         2 byte  RW  uint8   0.1S 1~255
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} pack overvoltage protection delay time"
    use_write_multiple: true
    address: 63
    register_type: holding
    value_type: U_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: 0.1
    max_value: 25.5
    step: 0.1
    mode: box
    unit_of_measurement: "s"

  #  64  Cell OV alarm                         2 byte  RW  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} cell overvoltage alarm"
    use_write_multiple: true
    address: 64
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "mV"

  #  65  Cell OV protection                    2 byte  RW  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} cell overvoltage protection"
    use_write_multiple: true
    address: 65
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "mV"

  #  66  Cell OV release protection            2 byte  RW  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} cell overvoltage protection release"
    use_write_multiple: true
    address: 66
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "mV"

  #  67  Cell OV protection delay time         2 byte  RW   uint8  0.1S 1~255
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} cell overvoltage protection delay time"
    use_write_multiple: true
    address: 67
    register_type: holding
    value_type: U_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: 0.1
    max_value: 25.5
    step: 0.1
    mode: box
    unit_of_measurement: "s"

  #  68  Pack UV alarm                         2 byte  RW  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} pack undervoltage alarm"
    use_write_multiple: true
    address: 68
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "mV"

  #  69  Pack UV protection                    2 byte  RW  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} pack undervoltage protection"
    use_write_multiple: true
    address: 69
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "mV"

  #  70  Pack UV release protection            2 byte  RW  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} pack undervoltage protection release"
    use_write_multiple: true
    address: 70
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "mV"

  #  71  Pack UV protection delay time         2 byte  RW   uint8  0.1S 1~255
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} pack undervoltage protection delay time"
    use_write_multiple: true
    address: 71
    register_type: holding
    value_type: U_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: 0.1
    max_value: 25.5
    step: 0.1
    mode: box
    unit_of_measurement: "s"

  #  72  Cell UV alarm                         2 byte  RW  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} cell undervoltage alarm"
    use_write_multiple: true
    address: 72
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "mV"

  #  73  Cell UV protection                    2 byte  RW  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} cell undervoltage protection"
    use_write_multiple: true
    address: 73
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "mV"

  #  74  Cell UV release protection            2 byte  RW  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} cell undervoltage protection release"
    use_write_multiple: true
    address: 74
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "mV"

  #  75  Cell UV protection delay time         2 byte  RW   uint8  0.1S 1~255
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} cell undervoltage protection delay time"
    use_write_multiple: true
    address: 75
    register_type: holding
    value_type: U_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: 0.1
    max_value: 25.5
    step: 0.1
    mode: box
    unit_of_measurement: "s"

  #  76  Charging OC alarm                     2 byte  RW  uint16  A
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} charging overcurrent alarm"
    use_write_multiple: true
    address: 76
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "A"

  #  77  Charging OC protection                2 byte  RW  uint16  A
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} charging overcurrent protection"
    use_write_multiple: true
    address: 77
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "A"

  #  78  Charging OC protection delay time     2 byte  RW   uint8  0.1S 1~255
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} charging overcurrent protection delay time"
    use_write_multiple: true
    address: 78
    register_type: holding
    value_type: U_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: 0.1
    max_value: 25.5
    step: 0.1
    mode: box
    unit_of_measurement: "s"

  #  79  Discharging OC alarm                  2 byte  RW  uint16  A
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} discharging overcurrent alarm"
    use_write_multiple: true
    address: 79
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "A"

  #  80  Discharging OC protection             2 byte  RW  uint16  A
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} discharging overcurrent protection"
    use_write_multiple: true
    address: 80
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "A"

  #  81  Discharging OC protection delay time  2 byte  RW   uint8  0.1S 1~255
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} discharging overcurrent protection delay time"
    use_write_multiple: true
    address: 81
    register_type: holding
    value_type: U_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: 0.1
    max_value: 25.5
    step: 0.1
    mode: box
    unit_of_measurement: "s"

  #  82  Discharging OC-2 protection             2 byte  RW  uint16  A
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} discharging overcurrent 2 protection"
    use_write_multiple: true
    address: 82
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "A"

  #  83  Discharging OC-2 protection delay time  2 byte  RW   uint8  0.025S 1~255
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} discharging overcurrent 2 protection delay time"
    use_write_multiple: true
    address: 83
    register_type: holding
    value_type: U_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: 0.1
    max_value: 25.5
    step: 0.1
    mode: box
    unit_of_measurement: "s"

  #  84  Charging OT alarm                     2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} charging overtemperature alarm"
    use_write_multiple: true
    address: 84
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  #  85  Charging OT protection                2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} charging overtemperature protection"
    use_write_multiple: true
    address: 85
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  #  86  Charging OT release protection        2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} charging overtemperature protection release"
    use_write_multiple: true
    address: 86
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  #  87  Discharging OT alarm                  2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} discharging overtemperature alarm"
    use_write_multiple: true
    address: 87
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  #  88  Discharging OT protection             2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} discharging overtemperature protection"
    use_write_multiple: true
    address: 88
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  #  89  Discharging OT release                2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} discharging overtemperature protection release"
    use_write_multiple: true
    address: 89
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  #  90  Charging UT alarm                     2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} charging undertemperature alarm"
    use_write_multiple: true
    address: 90
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  #  91  Charging UT protection                2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} charging undertemperature protection"
    use_write_multiple: true
    address: 91
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  #  92  Charging UT release protection        2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} charging undertemperature protection release"
    use_write_multiple: true
    address: 92
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  #  93  Discharging UT alarm                  2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} discharging undertemperature alarm"
    use_write_multiple: true
    address: 93
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  #  94  Discharging UT protection             2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} discharging undertemperature protection"
    use_write_multiple: true
    address: 94
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  #  95  Discharging UT release protection     2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} discharging undertemperature protection release"
    use_write_multiple: true
    address: 95
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  #  96  MOSFET OT alarm                       2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} mosfet overtemperature alarm"
    use_write_multiple: true
    address: 96
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  #  97  MOSFET OT protection                  2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} mosfet overtemperature protection"
    use_write_multiple: true
    address: 97
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  #  98  MOSFET OT release protection          2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} mosfet overtemperature protection release"
    use_write_multiple: true
    address: 98
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  #  99  Environment OT alarm                  2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} environment overtemperature alarm"
    use_write_multiple: true
    address: 99
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  # 100  Environment OT protection             2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} environment overtemperature protection"
    use_write_multiple: true
    address: 100
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  # 101  Environment OT release protection     2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} environment overtemperature protection release"
    use_write_multiple: true
    address: 101
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  # 102  Environment UT alarm                  2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} environment undertemperature alarm"
    use_write_multiple: true
    address: 102
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  # 103  Environment UT protection             2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} environment undertemperature protection"
    use_write_multiple: true
    address: 103
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  # 104  Environment UT release protection     2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} environment undertemperature protection release"
    use_write_multiple: true
    address: 104
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  # 105  Balance start cell voltage            2 byte  RW  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} balance start cell voltage"
    use_write_multiple: true
    address: 105
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "mV"

  # 106  Balance start delta voltage           2 byte  RW  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} balance start delta voltage"
    use_write_multiple: true
    address: 106
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "mV"

  # 107  Pack full-charge voltage              2 byte  RW  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} pack full charge voltage"
    use_write_multiple: true
    address: 107
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "mV"

  # 108  Pack full-charge current              2 byte  RW  uint16  mA
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} pack full-charge current"
    use_write_multiple: true
    address: 108
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "mA"

  # 109  Cell sleep voltage                    2 byte  RW  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} cell sleep voltage"
    use_write_multiple: true
    address: 109
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "mV"

  # 110  Cell sleep delay time                 2 byte  RW  uint16  min
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} cell sleep delay time"
    use_write_multiple: true
    address: 110
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "min"

  # 111  Short circuit protect delay time      2 byte  RW   uint8  25uS Max 500uS
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} short circuit protect delay time"
    use_write_multiple: true
    address: 111
    register_type: holding
    value_type: U_WORD
    lambda: "return x * 25.0f; "
    write_lambda: "return x * 0.04f;"
    min_value: 25.0
    max_value: 500.0
    step: 25.0
    mode: box
    unit_of_measurement: "us"

  # 112  SOC alarm threshold                   2 byte  RW   uint8  % 0~100%
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} state of charge alarm threshold"
    use_write_multiple: true
    address: 112
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 100.0
    step: 1
    mode: box
    unit_of_measurement: "%"

  # 113  Charging OC-2 protection              2 byte  RW  uint16  A
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} charging overcurrent 2 protection"
    use_write_multiple: true
    address: 113
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "A"

  # 114  Charging OC-2 protection delay time   2 byte  RW   uint8  0.025S 1~255
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} Charging overcurrent 2 protection delay time"
    use_write_multiple: true
    address: 114
    register_type: holding
    value_type: U_WORD
    lambda: "return x * 25.0f; "
    write_lambda: "return x * 0.04f;"
    min_value: 25.0
    max_value: 6375.0
    step: 25.0
    mode: box
    unit_of_measurement: "ms"

### DEYE
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: ${device_type}_Battery_equalization_voltage
    name: "${device_type}-Battery equalization voltage"
    address: 99
    unit_of_measurement: V
    value_type: U_WORD
    max_value: 55.4
    min_value: 53.0
    step: 0.1
    mode: box
    lambda: "return x * 0.01;"
    write_lambda: "return x * 100;"
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: ${device_type}_Battery_absorption_voltage
    name: "${device_type}-Battery absorption voltage"
    address: 100
    unit_of_measurement: V
    value_type: U_WORD
    max_value: 57.6
    min_value: 53.0
    step: 0.1
    mode: box
    lambda: "return x * 0.01;"
    write_lambda: "return x * 100;"
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: ${device_type}_Battery_float_voltage
    name: "${device_type}-Battery float voltage"
    address: 101
    unit_of_measurement: V
    value_type: U_WORD
    max_value: 55.4
    min_value: 53.0
    step: 0.1
    mode: box
    lambda: "return x * 0.01;"
    write_lambda: "return x * 100;"
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: ${device_type}_Maximum_battery_charge_current
    name: "${device_type}-Maximum battery charge current"
    address: 108
    unit_of_measurement: A
    value_type: U_WORD
    
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: ${device_type}_Maximum_battery_discharge_current
    name: "${device_type}-Maximum battery discharge current"
    address: 109
    unit_of_measurement: A
    value_type: U_WORD

  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: ${device_type}_Maximum_battery_grid_charge_current
    name: "${device_type}-Maximum battery_grid charge current"
    address: 128
    unit_of_measurement: A
    value_type: U_WORD

  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: ${device_type}_Time_point_1
    name: "${device_type}-Time point 1 start"
    address: 148
    value_type: U_WORD
    
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: ${device_type}_Time_point_2
    name: "${device_type}-Time point 2 start"
    address: 149
    value_type: U_WORD
    
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: ${device_type}_Time_point_3
    name: "${device_type}-Time point 3 start"
    address: 150
    value_type: U_WORD
    
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: ${device_type}_Time_point_4
    name: "${device_type}-Time point 4 start"
    address: 151
    value_type: U_WORD
    
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: ${device_type}_Time_point_5
    name: "${device_type}-Time point 5 start"
    address: 152
    value_type: U_WORD
    
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: ${device_type}_Time_point_6
    name: "${device_type}-Time point 6 start"
    address: 153
    value_type: U_WORD
    
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: ${device_type}_Time_point_1_power
    name: "${device_type}-Time point 1 power"
    unit_of_measurement: W
    address: 154
    value_type: U_WORD
    
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: ${device_type}_Time_point_2_power
    name: "${device_type}-Time point 2 power"
    unit_of_measurement: W
    address: 155
    value_type: U_WORD
    
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: ${device_type}_Time_point_3_power
    name: "${device_type}-Time point 3 power"
    unit_of_measurement: W
    address: 156
    value_type: U_WORD
    
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: ${device_type}_Time_point_4_power
    name: "${device_type}-Time point 4 power"
    unit_of_measurement: W
    address: 157
    value_type: U_WORD
    
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: ${device_type}_Time_point_5_power
    name: "${device_type}-Time point 5 power"
    unit_of_measurement: W
    address: 158
    value_type: U_WORD
    
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: ${device_type}_Time_point_6_power
    name: "${device_type}-Time point 6 power"
    unit_of_measurement: W
    address: 159
    value_type: U_WORD

  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: ${device_type}_Time_point_1_capacity
    name: "${device_type}-Time point 1 capacity"
    unit_of_measurement: "%"
    address: 166
    min_value: 0
    max_value: 100
    step: 5
    value_type: U_WORD
    
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: ${device_type}_Time_point_2_capacity
    name: "${device_type}-Time point 2 capacity"
    unit_of_measurement: "%"
    address: 167
    min_value: 0
    max_value: 100
    step: 5
    value_type: U_WORD
    
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: ${device_type}_Time_point_3_capacity
    name: "${device_type}-Time point 3 capacity"
    unit_of_measurement: "%"
    address: 168
    min_value: 0
    max_value: 100
    step: 5
    value_type: U_WORD
    
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: ${device_type}_Time_point_4_capacity
    name: "${device_type}-Time point 4 capacity"
    unit_of_measurement: "%"
    address: 169
    min_value: 0
    max_value: 100
    step: 5
    value_type: U_WORD
    
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: ${device_type}_Time_point_5_capacity
    name: "${device_type}-Time point 5 capacity"
    unit_of_measurement: "%"
    address: 170
    min_value: 0
    max_value: 100
    step: 5
    value_type: U_WORD
    
  - platform: modbus_controller
    use_write_multiple: true
    modbus_controller_id: ${modbus_controller_id}
    id: ${device_type}_Time_point_6_capacity
    name: "${device_type}-Time point 6 capacity"
    unit_of_measurement: "%"
    address: 171
    min_value: 0
    max_value: 100
    step: 5
    value_type: U_WORD

sensor:
### PACE
  #   0  Current                               2 byte   R   int16  10mA (Positive: chargingm Negative: discharging)
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} current"
    address: 0
    register_type: holding
    value_type: S_WORD
    unit_of_measurement: "A"
    device_class: current
    state_class: measurement
    accuracy_decimals: 2
    filters:
      - multiply: 0.01

  #   1  Voltage of pack                       2 byte   R  uint16  10mV
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} total voltage"
    address: 1
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 2
    filters:
      - multiply: 0.01

  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} power"
    address: 0
    register_type: holding
    value_type: U_WORD
    register_count: 2
    response_size: 4
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 2
    lambda: |-
      if (data.size() < 4) {
        return NAN;
      }
      float current = (int16_t)(data[0] << 8 | data[1] << 0);
      float total_voltage = (uint16_t)(data[2] << 8 | data[3] << 0);
      return current * total_voltage * 0.0001f;

  #   2  State of charge                       2 byte   R   uint8  % (0-100%)
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} state of charge"
    address: 2
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "%"
    device_class: battery
    state_class: measurement
    accuracy_decimals: 0

  #   3  SOH                                   2 byte   R   uint8  % (0-100%)
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} state of health"
    address: 3
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "%"
    state_class: measurement
    accuracy_decimals: 0

  #   4  Remain capacity                       2 byte   R  uint16  10mAH
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} remaining capacity"
    address: 4
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "Ah"
    state_class: measurement
    accuracy_decimals: 2
    filters:
      - multiply: 0.01

  #   5  Full capacity                         2 byte   R  uint16  10mAH
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} full capacity"
    address: 5
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "Ah"
    state_class: measurement
    accuracy_decimals: 2
    filters:
      - multiply: 0.01

  #   6  Design capacity                       2 byte   R  uint16  10mAH
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} design capacity"
    address: 6
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "Ah"
    state_class: measurement
    accuracy_decimals: 2
    filters:
      - multiply: 0.01

  #   7  Charging cycles count                 2 byte   R  uint16  Cyc.
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} charging cycles"
    address: 7
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: ""
    state_class: measurement
    accuracy_decimals: 0

  #   8  Reserved

  #   9  Warning flag                          2 byte   R  uint16  Hex See ^1
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} warnings bitmask"
    address: 9
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: ""
    state_class: measurement
    accuracy_decimals: 0

  #  10  Protection flag                       2 byte   R  uint16  Hex See ^2
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} protections bitmask"
    address: 10
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: ""
    state_class: measurement
    accuracy_decimals: 0

  #  11  Status/Fault flag                     2 byte   R  uint16  Hex See ^3
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} errors bitmask"
    address: 11
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: ""
    state_class: measurement
    accuracy_decimals: 0

  #  12  Balance status                        2 byte   R  uint16  Hex
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} balancer status"
    address: 12
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: ""
    state_class: measurement
    accuracy_decimals: 0

  #  13  Reserved
  #  14  Reserved

  #  15  Cell voltage 1                        2 byte   R  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} cell voltage 1"
    address: 15
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    state_class: measurement
    accuracy_decimals: 3
    filters:
      - multiply: 0.001

  #  16  Cell voltage 2                        2 byte   R  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} cell voltage 2"
    address: 16
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    state_class: measurement
    accuracy_decimals: 3
    filters:
      - multiply: 0.001

  #  17  Cell voltage 3                        2 byte   R  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} cell voltage 3"
    address: 17
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    state_class: measurement
    accuracy_decimals: 3
    filters:
      - multiply: 0.001

  #  18  Cell voltage 4                        2 byte   R  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} cell voltage 4"
    address: 18
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    state_class: measurement
    accuracy_decimals: 3
    filters:
      - multiply: 0.001

  #  19  Cell voltage 5                        2 byte   R  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} cell voltage 5"
    address: 19
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    state_class: measurement
    accuracy_decimals: 3
    filters:
      - multiply: 0.001

  #  20  Cell voltage 6                        2 byte   R  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} cell voltage 6"
    address: 20
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    state_class: measurement
    accuracy_decimals: 3
    filters:
      - multiply: 0.001

  #  21  Cell voltage 7                        2 byte   R  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} cell voltage 7"
    address: 21
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    state_class: measurement
    accuracy_decimals: 3
    filters:
      - multiply: 0.001

  #  22  Cell voltage 8                        2 byte   R  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} cell voltage 8"
    address: 22
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    state_class: measurement
    accuracy_decimals: 3
    filters:
      - multiply: 0.001

  #  23  Cell voltage 9                        2 byte   R  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} cell voltage 9"
    address: 23
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    state_class: measurement
    accuracy_decimals: 3
    filters:
      - multiply: 0.001

  #  24  Cell voltage 10                       2 byte   R  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} cell voltage 10"
    address: 24
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    state_class: measurement
    accuracy_decimals: 3
    filters:
      - multiply: 0.001

  #  25  Cell voltage 11                       2 byte   R  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} cell voltage 11"
    address: 25
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    state_class: measurement
    accuracy_decimals: 3
    filters:
      - multiply: 0.001

  #  26  Cell voltage 12                       2 byte   R  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} cell voltage 12"
    address: 26
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    state_class: measurement
    accuracy_decimals: 3
    filters:
      - multiply: 0.001

  #  27  Cell voltage 13                       2 byte   R  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} cell voltage 13"
    address: 27
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    state_class: measurement
    accuracy_decimals: 3
    filters:
      - multiply: 0.001

  #  28  Cell voltage 14                       2 byte   R  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} cell voltage 14"
    address: 28
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    state_class: measurement
    accuracy_decimals: 3
    filters:
      - multiply: 0.001

  #  29  Cell voltage 15                       2 byte   R  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} cell voltage 15"
    address: 29
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    state_class: measurement
    accuracy_decimals: 3
    filters:
      - multiply: 0.001

  #  30  Cell voltage 16                       2 byte   R  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} cell voltage 16"
    address: 30
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    state_class: measurement
    accuracy_decimals: 3
    filters:
      - multiply: 0.001

  ### Calculated sensors

  # Delta cell voltage
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} delta cell voltage"
    address: 15
    register_type: holding
    value_type: U_WORD
    register_count: 16
    response_size: 32
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 3
    lambda: |-
      uint8_t cells = 16;
      if (data.size() < cells * 2) {
        return NAN;
      }

      float min_cell_voltage = 100.0f;
      float max_cell_voltage = -100.0f;
      float average_cell_voltage = 0.0f;
      uint8_t min_voltage_cell = 0;
      uint8_t max_voltage_cell = 0;
      for (uint8_t i = 0; i < cells; i++) {
        float cell_voltage = (uint16_t)(data[item->offset + (i * 2)] << 8 | data[item->offset + (i * 2) + 1] << 0) * 0.001f;
        average_cell_voltage = average_cell_voltage + cell_voltage;
        if (cell_voltage < min_cell_voltage) {
            min_cell_voltage = cell_voltage;
            min_voltage_cell = i + 1;
        }
        if (cell_voltage > max_cell_voltage) {
          max_cell_voltage = cell_voltage;
          max_voltage_cell = i + 1;
        }
      }
      average_cell_voltage = average_cell_voltage / cells;

      id(bms0_average_cell_voltage).publish_state(average_cell_voltage);
      id(bms0_min_cell_voltage).publish_state(min_cell_voltage);
      id(bms0_max_cell_voltage).publish_state(max_cell_voltage);
      id(bms0_min_voltage_cell).publish_state(min_voltage_cell);
      id(bms0_max_voltage_cell).publish_state(max_voltage_cell);

      return max_cell_voltage - min_cell_voltage;

  - platform: template
    id: bms0_average_cell_voltage
    name: "${bms_name} average cell voltage"
    update_interval: never
    unit_of_measurement: V
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 3

  - platform: template
    id: bms0_min_cell_voltage
    name: "${bms_name} min cell voltage"
    update_interval: never
    unit_of_measurement: V
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 3

  - platform: template
    id: bms0_max_cell_voltage
    name: "${bms_name} max cell voltage"
    update_interval: never
    unit_of_measurement: V
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 3

  - platform: template
    id: bms0_min_voltage_cell
    name: "${bms_name} min voltage cell"
    update_interval: never
    unit_of_measurement: ""
    state_class: measurement
    accuracy_decimals: 0

  - platform: template
    id: bms0_max_voltage_cell
    name: "${bms_name} max voltage cell"
    update_interval: never
    unit_of_measurement: ""
    state_class: measurement
    accuracy_decimals: 0

  ####

  #  31  Battery temperature 1                 2 byte   R   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} battery temperature 1"
    address: 31
    register_type: holding
    value_type: S_WORD
    unit_of_measurement: "˚C"
    device_class: temperature
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  #  32  Battery temperature 2                 2 byte   R   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} battery temperature 2"
    address: 32
    register_type: holding
    value_type: S_WORD
    unit_of_measurement: "˚C"
    device_class: temperature
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  #  33  Battery temperature 3                 2 byte   R   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} battery temperature 3"
    address: 33
    register_type: holding
    value_type: S_WORD
    unit_of_measurement: "˚C"
    device_class: temperature
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  #  34  Battery temperature 4                 2 byte   R   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} battery temperature 4"
    address: 34
    register_type: holding
    value_type: S_WORD
    unit_of_measurement: "˚C"
    device_class: temperature
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  #  35  MOSFET temperature                    2 byte   R   int16  0.1 ℃ or invalid
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} mosfet temperature"
    address: 35
    register_type: holding
    value_type: S_WORD
    unit_of_measurement: "˚C"
    device_class: temperature
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  #  36  Environment temperature               2 byte   R   int16  0.1 ℃ or invalid
  - platform: modbus_controller
    modbus_controller_id: bms0
    name: "${bms_name} environment temperature"
    address: 36
    register_type: holding
    value_type: S_WORD
    unit_of_measurement: "˚C"
    device_class: temperature
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  #  37-59  Reserved


### DEYE
  - platform: template
    name: "${device_type}-PV Total Power"
    lambda: |-
      return (int)((id(${device_type}_PV1_Power).state + id(${device_type}_PV2_Power).state));
    update_interval: 5s
  - platform: modbus_controller #${device_type}-køleplade temeratur
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-Heat sink temperature"
    id: ${device_type}_koleplade_temeratur
    register_type: holding
    address: 541
    unit_of_measurement: "°C"
    value_type: S_WORD
    accuracy_decimals: 2
    filters:
      - offset: -1000
      - multiply:  0.1
 
  - platform: modbus_controller #${device_type}-load frequency
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-load frequency"
    id: ${device_type}_load_frequency
    register_type: holding
    address: 655
    unit_of_measurement: "Hz"
    state_class: "measurement"
    accuracy_decimals: 2
    filters:
      - multiply: 0.01
    value_type: U_WORD
 
  - platform: modbus_controller #${device_type}-inverter-frequency
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-inverter-frequency"
    id: ${device_type}_inverter_frequency
    register_type: holding
    address: 638
    unit_of_measurement: "Hz"
    state_class: "measurement"
    accuracy_decimals: 2
    filters:
      - multiply: 0.01
    value_type: U_WORD
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-PV1 Power"
    id: ${device_type}_PV1_Power
    register_type: holding
    address: 672
    unit_of_measurement: "W"
    state_class: "measurement"
    accuracy_decimals: 0
    value_type: U_WORD
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-PV2 Power"
    id: ${device_type}_PV2_Power
    register_type: holding
    address: 673
    unit_of_measurement: "W"
    state_class: "measurement"
    accuracy_decimals: 0
    value_type: U_WORD
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-PV1 Voltage"
    id: ${device_type}_PV1_Voltage
    register_type: holding
    address: 676
    unit_of_measurement: "V"
    state_class: "measurement"
    accuracy_decimals: 0
    filters:
      - multiply: 0.1
    value_type: U_WORD
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-PV2 Voltage"
    id: ${device_type}_PV2_Voltage
    register_type: holding
    address: 678
    unit_of_measurement: "V"
    state_class: "measurement"
    accuracy_decimals: 0
    filters:
      - multiply: 0.1
    value_type: U_WORD
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-PV1 Current"
    id: ${device_type}_PV1_Current
    register_type: holding
    address: 677
    unit_of_measurement: "A"
    state_class: "measurement"
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    value_type: U_WORD
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-PV2 Current"
    id: ${device_type}_PV2_Current
    register_type: holding
    address: 679
    unit_of_measurement: "A"
    state_class: "measurement"
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    value_type: U_WORD  
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-Daily Production"
    id: ${device_type}_Daily_Production
    register_type: holding
    address: 529
    unit_of_measurement: "kWh"
    state_class: "total_increasing"
    device_class: energy
    accuracy_decimals: 1
    filters:
      - multiply: 0.1
    value_type: U_WORD  
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-Total PV Production"  #Cumulative Production 
    id: ${device_type}_Total_PV_Production
    register_type: holding
    address: 534
    unit_of_measurement: "kWh"
    state_class: "measurement"
    device_class: energy
    accuracy_decimals: 1
    value_type: U_DWORD_R
    filters:
      - multiply: 0.1
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-Total Grid Power"   # Grid side total power
    id: ${device_type}_Total_Grid_Power
    register_type: holding
    address: 625
    unit_of_measurement: "W"
    state_class: "measurement"
    accuracy_decimals: 0
    value_type: S_WORD
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-Daily Energy Bought"
    id: ${device_type}_Daily_Energy_Bought
    register_type: holding
    address: 520
    unit_of_measurement: "kWh"
    state_class: "total_increasing"
    device_class: energy
    accuracy_decimals: 1
    value_type: U_WORD
    filters:
      - multiply: 0.1
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-Daily Energy Sold"
    id: ${device_type}_Daily_Energy_Sold
    register_type: holding
    address: 521
    unit_of_measurement: "kWh"
    state_class: "total_increasing"
    device_class: energy
    accuracy_decimals: 1
    value_type: U_WORD
    filters:
      - multiply: 0.1
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-Total Energy Bought"
    id: ${device_type}_Total_Energy_Bought
    register_type: holding
    address: 522
    unit_of_measurement: "kWh"
    state_class: "total_increasing"
    device_class: energy
    accuracy_decimals: 1
    value_type: U_WORD
    filters:
      - multiply: 0.1
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-Total Energy Sold"
    id: ${device_type}_Total_Energy_Sold
    register_type: holding
    address: 524
    unit_of_measurement: "kWh"
    state_class: "total_increasing"
    device_class: energy
    accuracy_decimals: 1
    value_type: U_WORD
    filters:
      - multiply: 0.1
 
  - platform: modbus_controller #Total Consumption
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-Total Consumption"
    id: ${device_type}_Total_Consumption
    register_type: holding
    address: 527
    unit_of_measurement: "kWh"
    state_class: "total_increasing"
    device_class: energy
    accuracy_decimals: 2
    value_type: U_DWORD_R
    filters:
      - multiply: 0.1
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-active power generation of today"
    id: ${device_type}_active_power_generation_of_today
    register_type: holding
    address: 502
    unit_of_measurement: "kWh"
    state_class: "total_increasing"
    device_class: energy
    accuracy_decimals: 1
    value_type: S_WORD
    filters:
      - multiply: 0.1
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-Grid Current L1"
    id: ${device_type}_Grid_Current_L1
    register_type: holding
    address: 630
    unit_of_measurement: "A"
    state_class: "measurement"
    accuracy_decimals: 1
    filters:
      - multiply: 0.01
    value_type: S_WORD  
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-Grid Current L2"
    id: ${device_type}_Grid_Current_L2
    register_type: holding
    address: 631
    unit_of_measurement: "A"
    state_class: "measurement"
    accuracy_decimals: 1
    filters:
      - multiply: 0.01
    value_type: S_WORD   
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-Grid Current L3"
    id: ${device_type}_Grid_Current_L3
    register_type: holding
    address: 632
    unit_of_measurement: "A"
    state_class: "measurement"
    accuracy_decimals: 1
    filters:
      - multiply: 0.01
    value_type: S_WORD   
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-Grid Voltage L1"
    id: ${device_type}_Grid_Voltage_L1
    register_type: holding
    address: 598
    unit_of_measurement: "V"
    state_class: "measurement"
    accuracy_decimals: 0
    filters:
      - multiply: 0.1
    value_type: U_WORD     
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-Grid Voltage L2"
    id: ${device_type}_Grid_Voltage_L2
    register_type: holding
    address: 599
    unit_of_measurement: "V"
    state_class: "measurement"
    accuracy_decimals: 0
    filters:
      - multiply: 0.1
    value_type: U_WORD     
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-Grid Voltage L3"
    id: ${device_type}_Grid_Voltage_L3
    register_type: holding
    address: 600
    unit_of_measurement: "V"
    state_class: "measurement"
    accuracy_decimals: 0
    filters:
      - multiply: 0.1
    value_type: U_WORD  

 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-Internal CT L1 Power"
    id: ${device_type}_Internal_CT_L1_Power
    register_type: holding
    address: 604
    unit_of_measurement: "W"
    state_class: "measurement"
    accuracy_decimals: 0
    value_type: S_WORD  
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-Internal CT L2 Power"
    id: ${device_type}_Internal_CT_L2_Power
    register_type: holding
    address: 605
    unit_of_measurement: "W"
    state_class: "measurement"
    accuracy_decimals: 0
    value_type: S_WORD  
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-Internal CT L3 Power"
    id: ${device_type}_Internal_CT_L3_Power
    register_type: holding
    address: 606
    unit_of_measurement: "W"
    state_class: "measurement"
    accuracy_decimals: 0
    value_type: S_WORD  
 
  - platform: modbus_controller  # Grid internal - total active power
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-Internal total Power" 
    id: ${device_type}_Internal_total_Power
    register_type: holding
    address: 607
    unit_of_measurement: "W"
    state_class: "measurement"
    accuracy_decimals: 0
    value_type: S_WORD   
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-External CT L1 Power"
    id: ${device_type}_External_CT_L1_Power
    register_type: holding
    address: 616
    unit_of_measurement: "W"
    state_class: "measurement"
    accuracy_decimals: 0
    value_type: S_WORD  
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-External CT L2 Power"
    id: ${device_type}_External_CT_L2_Power
    register_type: holding
    address: 617
    unit_of_measurement: "W"
    state_class: "measurement"
    accuracy_decimals: 0
    value_type: S_WORD  
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-External CT L3 Power"
    id: ${device_type}_External_CT_L3_Power
    register_type: holding
    address: 618
    unit_of_measurement: "W"
    state_class: "measurement"
    accuracy_decimals: 0
    value_type: S_WORD     
 
  - platform: modbus_controller  
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-Out-of-grid–total power"
    id: ${device_type}_out_of_grid_total_power
    register_type: holding
    address: 619
    unit_of_measurement: "W"
    state_class: "measurement"
    accuracy_decimals: 0
    value_type: S_WORD
    
  - platform: modbus_controller # Load totalpower
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-Load totalpower" 
    id: ${device_type}_Load_totalpower
    register_type: holding
    address: 653
    unit_of_measurement: "W"
    state_class: "measurement"
    accuracy_decimals: 0
    value_type: S_WORD
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-Warning1"
    id:  ${device_type}_Warning1
    register_type: holding
    address: 553
    accuracy_decimals: 0
    value_type: U_WORD
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-Warning2"
    id:  ${device_type}_Warning2
    register_type: holding
    address: 554
    accuracy_decimals: 0
    value_type: U_WORD
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-Warning3"
    id:  ${device_type}_Warning3
    register_type: holding
    address: 555
    accuracy_decimals: 0
    value_type: U_WORD
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-Error1"
    id:  ${device_type}_Error1
    register_type: holding
    address: 556
    accuracy_decimals: 0
    value_type: U_WORD
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-Error2"
    id:  ${device_type}_Error2
    register_type: holding
    address: 557
    accuracy_decimals: 0
    value_type: U_WORD
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-Error3"
    id:  ${device_type}_Error3
    register_type: holding
    address: 558
    accuracy_decimals: 0
    value_type: U_WORD
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-Failure status of communication board"
    id:  ${device_type}_Failure_status_of_communication_board
    register_type: holding
    address: 548
    accuracy_decimals: 0
    value_type: U_WORD
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-Minimum insulation impedance"
    id:  ${device_type}_Minimum_insulation_impedance
    register_type: holding
    unit_of_measurement: "kΩ"
    state_class: "measurement"
    address: 65
    accuracy_decimals: 0
    value_type: U_WORD
    filters:
      - multiply: 0.1
 
  # Batterie
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-Today charge of the battery"
    id:  ${device_type}_Today_charge_of_the_battery
    register_type: holding
    address: 514
    unit_of_measurement: "kWh"
    state_class: "total_increasing"
    device_class: energy
    accuracy_decimals: 1
    value_type: U_WORD
    filters:
      - multiply: 0.1
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-Today discharge of the battery"
    id:  ${device_type}_Today_discharge_of_the_battery
    register_type: holding
    address: 515
    unit_of_measurement: "kWh"
    state_class: "total_increasing"
    device_class: energy
    accuracy_decimals: 1
    value_type: U_WORD
    filters:
      - multiply: 0.1
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    skip_updates: 5
    name: "${device_type}-Total charge of the battery"
    id:  ${device_type}_battery_total_charge
    register_type: holding
    address: 516
    unit_of_measurement: "kWh"
    state_class: "total_increasing"
    device_class: energy
    accuracy_decimals: 1
    value_type: U_DWORD_R
    filters:
      - multiply: 0.1
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    skip_updates: 5
    name: "${device_type}-Total discharge of the battery"
    id:  ${device_type}_battery_total_discharge
    register_type: holding
    address: 518
    unit_of_measurement: "kWh"
    state_class: "total_increasing"
    device_class: energy
    accuracy_decimals: 1
    value_type: U_DWORD_R 
    filters:
      - multiply: 0.1
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-battery temperature"
    id:  ${device_type}_battery_temperature
    register_type: holding
    address: 586
    unit_of_measurement: "°C"
    accuracy_decimals: 1
    value_type: U_WORD 
    filters:
      - offset: -1000
      - multiply: 0.1
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-battery voltage"
    id: ${device_type}_battery_voltage
    register_type: holding
    address: 587
    unit_of_measurement: "V"
    state_class: "measurement"
    accuracy_decimals: 2
    filters:
      - multiply: 0.01
    value_type: U_WORD
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-battery capacity"
    id: ${device_type}_battery_capacity
    register_type: holding
    address: 588
    unit_of_measurement: "%"
    state_class: "measurement"
    accuracy_decimals: 1
    value_type: U_WORD
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-Battery output power"
    id: ${device_type}_Battery_output_power
    register_type: holding
    address: 590
    unit_of_measurement: "W"
    state_class: "measurement"
    accuracy_decimals: 0
    value_type: S_WORD 
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-Battery output current"
    id: ${device_type}_Battery_output_current
    register_type: holding
    address: 591
    unit_of_measurement: "A"
    state_class: "measurement"
    accuracy_decimals: 2
    filters:
      - multiply: 0.01
    value_type: S_WORD
 
  - platform: modbus_controller
    modbus_controller_id: ${modbus_controller_id}
    name: "${device_type}-The corrected capacity of the battery"
    id: ${device_type}_The_corrected_capacity_of_the_battery
    register_type: holding
    address: 592
    unit_of_measurement: "Ah"
    state_class: "measurement"
    accuracy_decimals: 0
    value_type: U_WORD